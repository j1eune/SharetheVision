<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="approvalMapper">

	<resultMap type="Member" id="MemberResultMap">
		<id column="M_CODE" property="mCode"/>
		<result column="M_NAME" property="name"/>
		<result column="M_ID" property="mId"/>
		<result column="DEPT_NO" property="deptNo"/>
		<result column="DEPT_NAME" property="deptName"/>
		<result column="J_NO" property="jobNo"/>
		<result column="J_NAME" property="jobName"/>
	</resultMap>
	
	<select id="apList" resultMap="MemberResultMap">
		SELECT M_CODE, M_NAME, M_ID, DEPT_NO, DEPT_NAME, J_NAME, J_NO
		FROM MEMBER
			JOIN DEPARTMENT USING(DEPT_NO)
			JOIN JOB USING(J_NO)
		WHERE M_STATUS='Y'
		ORDER BY DEPT_NO ASC, J_NO DESC
	</select>
	
	
	<resultMap type="ApprovalAttachDTO" id="attachmentResultSet">
		<id column="ATTACH_NO" property="attachNo"/>
		<result column="APV_NO" property="apvNo"/>
		<result column="APT_ORIGIN_NAME" property="aptOriginName"/>
		<result column="APT_SAVE_NAME" property="aptSaveName"/>
		<result column="APT_PATH" property="aptPath"/>
		<result column="APT_FILE_SIZE" property="aptFileSize"/>
		<result column="DEL_YN" property="delYn"/>
		<result column="REG_DATE" property="regDate"/>
		<result column="UPD_DATE" property="updDate"/>
	</resultMap>
	
	<select id="selectAttachedFile" resultMap="attachmentResultSet">
		SELECT *
		FROM APPROVAL_ATTACH
		WHERE APV_NO = #{apvNo}
	</select>
	
	<!-- 
	<insert id="insertApproval">
		INSERT INTO APPROVAL VALUES(SEQ_APV.NEXTVAL, #{apvType}, #{mCode}, #{apvAgr}, #{apvRef}, #{apvApp},
						   			#{apvTitle}, #{apvCom}, SYSDATE, SYSDATE + 10, #{apvDdate}, 'A', #{apvRefNo})
	</insert>
	-->
	
	<select id="selectApproval" resultMap="approvalResultSet">
		SELECT A.*, AT.AT_CHANGE, M.M_NAME
		FROM APPROVAL A
			 LEFT JOIN ATTACHMENTS AT ON (A.M_CODE = AT_CATEGORY)
			 LEFT JOIN MEMBER M ON (M.M_CODE = A.M_CODE) 
		<where>
			<if test="mCode != null">
				A.M_CODE = #{mCode}
			</if>
			<if test="apvType != null">
				OR APV_TYPE = #{apvType}
			</if>
			<if test="apvAgr != null">
				OR APV_AGR LIKE '%'||#{apvAgr}||'%'
			</if>
			<if test="apvRef != null">
				OR APV_REF LIKE '%'||#{apvRef}||'%'
			</if>
			<if test="apvApp != null">
				OR APV_APP LIKE '%'||#{apvApp}||'%'
			</if>
		</where>
		ORDER BY APV_NO DESC
	</select>
	
	<resultMap type="Approval" id="approvalResultSet">
		<id column="APV_NO" property="apvNo"/>
		<result column="APV_TYPE" property="apvType"/>
		<result column="APV_AGR" property="apvAgr"/>
		<result column="APV_REF" property="apvRef"/>
		<result column="APV_APP" property="apvApp"/>
		<result column="APT" property="apt"/>
		<result column="COMMENT" property="comment"/>
		<result column="ARRIVE" property="arrive"/>
		<result column="DEPART" property="depart"/>
		<result column="APV_EDATE" property="apvEdate"/>
		<result column="APV_STATUS" property="apvStatus"/>
		<result column="APV_REF_NO" property="apvRefNo"/>
		<result column="M_CODE" property="mCode"/>
		<result column="AT_CHANGE" property="atChange"/>
		<result column="M_NAME" property="mName"/>
	</resultMap>
	
	<select id="selectOne" resultMap="approvalResultSet">
		SELECT *
		FROM (SELECT AP.*, AT.AT_CHANGE, M.M_NAME
			  FROM APPROVAL AP
			  	LEFT JOIN ATTACHMENTS AT ON(M_CODE = AT_CATEGORY)
			  	JOIN MEMBER M ON(M.M_CODE = AP.M_CODE)
			  WHERE AT_LEVEL = 1)
		WHERE APV_NO = #{apvNo}
	</select>

	<insert id="insertApproval" parameterType="com.kh.SharetheVision.approval.model.vo.ApprovalVO">
		INSERT INTO APPROVAL (APV_NO
							, APV_TYPE
							, M_CODE
							, APV_AGR
							, APV_REF
							, APV_APP
							, APT
							, "COMMENT"
							, ARRIVE
							, DEPART
							 ) VALUES (
							  SEQ_APV.NEXTVAL
							, #{apvType}
							, #{mCode}
							, #{apvAgr}
							, #{apvRef}
							, #{apvApp}
							, #{apt}
							, #{comment}
							, #{arrive}
							, #{depart}
							 )
		<selectKey keyProperty="apvNo" resultType="int" order="AFTER">
			SELECT SEQ_APV.CURRVAL FROM DUAL
		</selectKey>
	</insert>
	<insert id="insertApprovalAttach" parameterType="com.kh.SharetheVision.approval.model.vo.ApprovalAttachDTO">
		INSERT INTO APPROVAL_ATTACH (ATTACH_NO
								  , APV_NO
								  , APT_ORIGIN_NAME
								  , APT_SAVE_NAME
								  , APT_PATH
								  , APT_FILE_SIZE
								  , DEL_YN
								  , REG_DATE
								   ) VALUES (
								    SEQ_APV_ATTACH.NEXTVAL
								  , #{apvNo}
								  , #{aptOriginName}
								  , #{aptSaveName}
								  , #{aptPath}
								  , #{aptFileSize}
								  , 'N'
								  , SYSDATE
								   )
	</insert>
</mapper>
