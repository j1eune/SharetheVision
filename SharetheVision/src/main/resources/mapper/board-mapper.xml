<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="boardMapper">

	<resultMap type="Board" id="boardResultSet">
		<id column="B_NO" property="boardNo"/>
		<result column="B_TYPE" property="boardType"/>
		<result column="B_TITLE" property="boardTitle"/>
		<result column="B_CONTENT" property="boardContent"/>
		<result column="B_CREATEDATE" property="boardCreateDate"/>
		<result column="B_STATE" property="boardState"/>
		<result column="B_STATUS" property="boardStatus"/>
		<result column="M_CODE" property="memberCode"/>
		<result column="DEPT_NO" property="deptNo"/>
		<result column="B_WRITER" property="boardWriter"/>
		<result column="PROJECT" property="project"/>
	</resultMap>
	
	<resultMap type="Attachment" id="attachmentResultSet">
		<id column="AT_NO" property="atNo"/>
		<result column="AT_LEVEL" property="atLevel"/>
		<result column="AT_CATEGORY" property="atCategory"/>
		<result column="AT_PATH" property="atPath"/>
		<result column="AT_ORIGIN" property="atOrigin"/>
		<result column="AT_CHANGE" property="atChange"/>
		<result column="AT_EXTENTION" property="atExtention"/>
		<result column="AT_STATUS" property="atStatus"/>
	</resultMap>
	
	<resultMap type="Reply" id="replyResultSet">
		<id column="R_NO" property="replyNo"/>
		<result column="R_WRITER" property="replyWriter"/>
		<result column="R_CONTENT" property="replyContent"/>
		<result column="R_CREATEDATE" property="replyCreateDate"/>
		<result column="J_NAME" property="jobName"/>
		<result column="D_NAME" property="deptName"/>
		<result column="R_STATUS" property="replyStatus"/>
		<result column="M_CODE" property="memberCode"/>
		<result column="B_NO" property="boardNo"/>
	</resultMap>
	

	<select id="selectListCount" resultType="_int">
		select count(*)
		from board
		where b_status = 'Y' and dept_no = #{deptNo}
	</select>
	
	<select id="selectBoardList" resultMap="boardResultSet">
		<!-- v -->
		select *
		from board
		where b_status = 'Y' and dept_no = #{deptNo}
		order by b_no desc
	</select>

	<select id="selectNewBoard" resultMap="boardResultSet">
		<!-- v -->
		<![CDATA[
			select *
			from (select *
				  from board
				  where b_type=2 and dept_no=#{deptNo} and b_status='Y'
				  order by b_no desc)
			where rownum <= 3
		]]>
	</select>
	
	<select id="selectBoardDetail" resultMap="boardResultSet">
		<!-- v -->
		select *
		from board
		where b_status='Y' and b_no=#{bId}
	</select>
	
	<select id="selectProjectList" resultMap="projectResultSet">
		select p_name
		from project
		where dept_no = #{deptNo} and p_status='Y' and p_end='N'
	</select>
	
	<resultMap type="Project" id="projectResultSet">
		<id column="pNo" property="pNo"/>
		<result column="P_NO" property="mCode"/>
		<result column="P_NAME" property="pName"/>
		<result column="P_INTRO" property="pIntro"/>
		<result column="P_STATUS" property="pStatus"/>
		<result column="P_END" property="pEnd"/>
		<result column="DEPT_NO" property="deptNo"/>
	</resultMap>
	
	<insert id="insertBoard">
		insert into
		board values(seq_bno.nextval, 2, #{boardTitle}, #{boardContent}, default, default, default, #{memberCode}, #{deptNo}, #{boardWriter}, #{project})
	</insert>

	<select id="selectLastBoard" resultMap="boardResultSet">
		select * from (select * from board order by b_no desc) where rownum = 1
	</select>
	
	<insert id="insertAttachFile">
		insert into
		attachments values(seq_at.nextval, #{atLevel}, #{atCategory}, #{atPath}, #{atOrigin}, #{atChange}, null, default)
	</insert>
	
	<insert id="insertScrap">
		insert into
		scrap values(#{mCode}, #{boardNo}, #{project}, #{boardTitle}, #{boardWriter}, default)
	</insert>

	<select id="scrapState" resultMap="scrapResultSet">
		select *
		from scrap where b_no=#{boardNo} and m_code=#{mCode}
	</select>

	<resultMap type="Scrap" id="scrapResultSet">
		<id column="M_CODE" property="mCode"/>
		<id column="B_NO" property="boardNo"/>
		<result column="PROJECT" property="project"/>
		<result column="B_TITLE" property="boardTitle"/>
		<result column="B_WRITER" property="boardWriter"/>
		<result column="B_STATE" property="boardState"/>
	</resultMap>
	
	<delete id="deleteScrap">
		delete
		from scrap
		where b_no=#{boardNo} and m_code=#{mCode}
	</delete>
	
	<select id="scrapList" resultMap="scrapResultSet">
		select *
		from v_scrap
		where m_code=#{mCode}
		order by scrap_date desc
	</select>
	
	<select id="selectScrapListCount" resultType="_int">
		select count(*)
		from scrap
		where m_code=#{mCode}
	</select>
	
	<select id="selectScrapBoardList" resultMap="scrapResultSet">
		select *
		from scrap
		where m_code = #{mCode}
		order by scrap_date desc
	</select>
	
	<select id="selectBoardStatus" resultMap="boardResultSet">
		select *
		from board
		where b_status='N' and b_no=#{bId}
	</select>
	
	<select id="selectSearchBoard" resultMap="boardResultSet">
		select *
		from board
		<if test="category == 'title'">
		where b_title like '%'||#{word}||'%'
		</if>
		<if test="category == 'project'">
		where project like '%'||#{word}||'%'
		</if>
		<if test="category == 'writer'">
		where b_writer like '%'||#{word}||'%'
		</if>
		and dept_no = #{deptNo} and b_status = 'Y'
		order by b_no desc
	</select>
	
	<select id="selectSearchListCount" resultType="_int">
		select count(*)
		from board
		<if test="category == 'title'">
		where b_title like '%'||#{word}||'%'
		</if>
		<if test="category == 'project'">
		where project like '%'||#{word}||'%'
		</if>
		<if test="category == 'writer'">
		where b_writer like '%'||#{word}||'%'
		</if>
		and dept_no = #{deptNo} and b_status = 'Y'
	</select>
	
	<select id="selectAttechedFile" resultMap="attachmentResultSet">
		select *
		from attachments
		where at_level = 3 and at_category = #{bId} and at_status='Y'
	</select>
	
	<update id="deleteBoard">
		update board set b_status = 'N' where b_no = #{bId}
	</update>
	
	<update id="deleteBoardAttachFile">
		update attachments set at_status = 'N' where at_level = 3 and at_category = #{bId}
	</update>
	
	<update id="changeBoard">
		UPDATE BOARD
		<if test="condition == 1">
		SET B_STATE = 2
		</if>
		<if test="condition == 2">
		SET B_STATE = 1
		</if>
		<if test="condition == 3">
		SET B_STATUS = 'N'
		</if>
		WHERE PROJECT = #{projectName}
	</update>
	
	<delete id="deleteProjectScrap">
		DELETE
		FROM SCRAP
		WHERE PROJECT = #{projectName} AND M_CODE = #{mCode}
	</delete>

	<update id="updateBoard">
		update board set b_title = #{boardTitle}, b_content = #{boardContent}, project = #{project} where b_no = #{boardNo}
	</update>
	
	<insert id="insertReply">
		insert into reply values(SEQ_REPLY.NEXTVAL, #{replyWriter}, #{replyContent}, default, #{jobName}, #{deptName}, default, #{memberCode}, #{boardNo})
	</insert>
	
	<select id="selectReplyList" resultMap="replyResultSet">
		select * from
		reply
		where b_no = #{bId} and r_status = 'Y'
	</select>
	
	<update id="deleteReply">
		update reply
		set r_status = 'N'
		where r_no = #{replyNo}
	</update>
	
	<select id="selectUserProfileImage" resultMap="attachmentResultSet">
		select * from
		attachments
		where at_level = 1 and at_status = 'Y' and at_category = #{writermCode}
	</select>
	
</mapper>
